-- [[ PROTEKSI LOAD LIBRARY ]] --
local success, Rayfield = pcall(function()
    return loadstring(game:HttpGet('https://sirius.menu/rayfield'))()
end)

if not success or Rayfield == nil then
    warn("GAGAL LOAD RAYFIELD: Server Sirius mungkin sedang down atau koneksi lambat.")
    return -- Berhenti supaya tidak muncul error 'nil value'
end

-- [[ CORE SERVICES ]] --
local ReplicatedStorage = game:GetService("ReplicatedStorage")
local RunService = game:GetService("RunService")
local Stats = game:GetService("Stats")
local Player = game:GetService("Players").LocalPlayer
local PlayerData = Player:WaitForChild("PlayerData", 10) -- Tambahkan timeout agar tidak stuck
local KurirEvent = ReplicatedStorage:WaitForChild("Events"):WaitForChild("KurirEvent")
local VirtualUser = game:GetService("VirtualUser") 

-- [[ CONFIG & VARIABLES ]] --
_G.AutoKurir = false
_G.TPSpeed = 0.1
_G.TargetMoney = 0

local StartMoney = (PlayerData and PlayerData:FindFirstChild("RPValue")) and PlayerData.RPValue.Value or 0
local TotalEarned = 0
local SecondsRunning = 0
local TargetPos = nil
local TargetName = ""
local JobStarted = false

-- [[ ANTI AFK SYSTEM ]] --
Player.Idled:Connect(function()
    pcall(function()
        VirtualUser:CaptureController()
        VirtualUser:ClickButton2(Vector2.new())
    end)
end)

-- [[ ALAMAT MANUAL ]] --
local LocationMap = {
    ["Faisal's AUTOSHOP"] = Vector3.new(2097.47, 5.18, -2999.67),
    ["IndomaretCheck"] = Vector3.new(-4226.77, 4.12, -826.71),
    ["Mie Kalceran"] = Vector3.new(1512.47, 4.10, -5119.81),
    ["Modification"] = Vector3.new(208.21, 3.10, 398.88),
    ["Oguri Seafood"] = Vector3.new(-454.33, 4.10, -1401.51),
    ["Ruko Kosong"] = Vector3.new(1015.69, 4.10, -3868.76),
    ["Rumah Sakit"] = Vector3.new(1949.77, 4.14, -476.08)
}

local SpawnPos = CFrame.new(-182.195, 3.817, -70.095)
local DepotPos = CFrame.new(-246.479, 6.099, -26.851)
local VisualPaketPos = CFrame.new(-182.134, 4.245, -80.808)

-- [[ FORMATTER FUNCTIONS ]] --
local function FormatMoney(amount)
    local formatted = tostring(math.floor(math.abs(amount)))
    local k
    while true do
        formatted, k = string.gsub(formatted, "^(-?%d+)(%d%d%d)", '%1.%2')
        if (k == 0) then break end
    end
    return (amount < 0 and "-RP. " or "RP. ") .. formatted
end

local function FormatTime(seconds)
    local hours = math.floor(seconds / 3600)
    local mins = math.floor((seconds % 3600) / 60)
    local secs = seconds % 60
    return string.format("%02d:%02d:%02d", hours, mins, secs)
end

-- [[ MAIN FUNCTIONS ]] --
local function StartFarming()
    task.spawn(function()
        while _G.AutoKurir do
            local char = Player.Character
            local root = char and char:FindFirstChild("HumanoidRootPart")
            if not root then task.wait(1) continue end

            local success, err = pcall(function()
                if not JobStarted then
                    KurirEvent:FireServer("ToggleJob")
                    JobStarted = true
                    task.wait(0.5)
                end

                root.CFrame = SpawnPos
                task.wait(0.8)
                KurirEvent:FireServer("SpawnTruck")
                
                task.wait(1)
                root.CFrame = DepotPos
                task.wait(0.8)
                
                -- Deteksi Proximity Depot lebih aman
                local depot = workspace:FindFirstChild("DepotPaket")
                if depot and depot:FindFirstChild("PromptAmbil") then
                    fireproximityprompt(depot.PromptAmbil)
                end
                
                KurirEvent:FireServer("RequestMisi")
                
                local timer = 0
                while TargetName == "" and timer < 15 and _G.AutoKurir do
                    task.wait(0.5)
                    timer = timer + 1
                end

                if TargetName == "" or not TargetPos then return end

                root.CFrame = VisualPaketPos
                task.wait(1)
                
                -- Cari Truck Player
                local myTruck = workspace:FindFirstChild("Truck_" .. Player.Name)
                if myTruck and myTruck:FindFirstChild("PaketVisual") then
                    local p = myTruck.PaketVisual:FindFirstChildOfClass("ProximityPrompt")
                    if p then 
                        fireproximityprompt(p)
                        task.wait(5.5)
                    end
                end

                task.wait(_G.TPSpeed)
                root.CFrame = CFrame.new(TargetPos + Vector3.new(0, 20, 0))
                
                task.wait(1.5)
                local dp = workspace:FindFirstChild("DeliveryPoints") and workspace.DeliveryPoints:FindFirstChild(TargetName)
                if dp then
                    local prompt = dp:FindFirstChildOfClass("ProximityPrompt")
                    if prompt then fireproximityprompt(prompt) end
                end
                KurirEvent:FireServer("SelesaiMisi")
                
                TargetPos = nil
                TargetName = ""
                task.wait(2)
            end)
            if not success then warn("Farm Error: " .. tostring(err)) end
        end
    end)
end

KurirEvent.OnClientEvent:Connect(function(areaName, areaData)
    TargetName = tostring(areaName)
    if typeof(areaData) == "Vector3" then 
        TargetPos = areaData
    elseif typeof(areaData) == "Instance" and areaData:IsA("BasePart") then 
        TargetPos = areaData.Position
    else 
        TargetPos = LocationMap[TargetName] 
    end
end)

-- [[ UI WINDOW ]] --
local Window = Rayfield:CreateWindow({
   Name = "billzz hub",
   LoadingTitle = "Stellar Hub Kurir",
   LoadingSubtitle = "by bill",
   ConfigurationSaving = { Enabled = false },
   KeySystem = false 
})

local TabFarm = Window:CreateTab("Autofarm", "truck")
TabFarm:CreateToggle({
   Name = "Autofarm On/Off",
   CurrentValue = false,
   Callback = function(Value)
      _G.AutoKurir = Value
      if Value then StartFarming() end
   end,
})

TabFarm:CreateInput({
   Name = "Speed Teleport",
   PlaceholderText = "Default: 0.1",
   Callback = function(Text) _G.TPSpeed = tonumber(Text) or 0.1 end,
})

-- TAB 2: STATS
local TabStats = Window:CreateTab("Stats", "trending-up")
local LabelTime = TabStats:CreateLabel("Running Time: 00:00:00")
local LabelTotal = TabStats:CreateLabel("Total Earning: RP. 0")

-- [[ STATS LOOP ]] --
task.spawn(function()
    while true do
        task.wait(1)
        pcall(function()
            if _G.AutoKurir then SecondsRunning = SecondsRunning + 1 end
            if PlayerData and PlayerData:FindFirstChild("RPValue") then
                TotalEarned = PlayerData.RPValue.Value - StartMoney
                LabelTotal:Set("Total Earning: " .. FormatMoney(TotalEarned))
            end
            LabelTime:Set("Running Time: " .. FormatTime(SecondsRunning))
        end)
    end
end)

Rayfield:Notify({Title = "billzz hub", Content = "Script Loaded using Sirius!", Duration = 5})
