-- MIYOSHI BLACK PREMIUM v12 - FINAL STABIL (NO BUG)

local Players = game:GetService("Players")
local VirtualInputManager = game:GetService("VirtualInputManager")
local UserInputService = game:GetService("UserInputService")
local RunService = game:GetService("RunService")
local player = Players.LocalPlayer
local character = player.Character or player.CharacterAdded:Wait()
local cam = workspace.CurrentCamera

-- KOORDINAT MANUAL (PENGANTARAN 1-3)
local ManualLocations = {
    Vector3.new(2879, 4, -863),
    Vector3.new(-5, 4, 25),
    Vector3.new(3141, 5, -111)
}

local autofarm = false
local flying = false
local noclip = false
local espEnabled = false
local customDelay = 6
local deliveryCount = 0  -- hitung berapa kali sudah ngantar
local lastMoney = 0
local profitPerMin = 0

-- PROFIT PER MENIT
spawn(function()
    lastMoney = getMoney()
    while task.wait(10) do
        local now = getMoney()
        profitPerMin = (now - lastMoney) * 6
        lastMoney = now
    end
end)

function getMoney()
    if player:FindFirstChild("leaderstats") then
        for _, v in player.leaderstats:GetChildren() do
            if v:IsA("ValueBase") and (v.Name:lower():find("money") or v.Name:lower():find("cash") or v.Name:lower():find("coin")) then
                return v.Value
            end
        end
    end
    return 0
end

-- CARI WAYPOINT TERDEKAT (AKURAT)
local function getNearestWaypoint()
    local hrp = character:FindFirstChild("HumanoidRootPart")
    if not hrp then return nil end
    local bestPos = nil
    local bestDist = math.huge
    for _, obj in workspace:GetDescendants() do
        if obj:IsA("BasePart") or obj:IsA("Model") then
            local n = obj.Name:lower()
            if n:find("way") or n:find("mark") or n:find("point") or n:find("target") or n:find("path") or n:find("deliver") then
                local pos = obj:IsA("BasePart") and obj.Position or (obj:FindFirstChildWhichIsA("BasePart") and obj:FindFirstChildWhichIsA("BasePart").Position)
                if pos then
                    local dist = (hrp.Position - pos).Magnitude
                    if dist < bestDist and dist < 300 then  -- max 300 studs
                        bestDist = dist
                        bestPos = pos + Vector3.new(0, 5, 0)
                    end
                end
            end
        end
    end
    return bestPos
end

-- NAMA "hide name by miyoshi"
local function setMiyoshiName()
    if character and character:FindFirstChild("Head") then
        for _, v in character.Head:GetChildren() do
            if v:IsA("BillboardGui") then
                for _, lbl in v:GetDescendants() do
                    if lbl:IsA("TextLabel") then
                        lbl.Text = "hide name by miyoshi"
                        lbl.TextColor3 = Color3.new(1,1,1)
                        lbl.TextStrokeTransparency = 0
                        lbl.TextStrokeColor3 = Color3.new(0,0,0)
                        lbl.Font = Enum.Font.GothamBold
                        lbl.TextSize = 20
                    end
                end
            end
        end
    end
end
player.CharacterAdded:Connect(function(c) character = c task.wait(2) setMiyoshiName() end)

-- HOLD E 5 DETIK
local function holdE5()
    VirtualInputManager:SendKeyEvent(true, Enum.KeyCode.E, false, game)
    task.wait(5)
    VirtualInputManager:SendKeyEvent(false, Enum.KeyCode.E, false, game)
end

-- TELEPORT
local function tp(pos)
    local root = character:FindFirstChild("HumanoidRootPart")
    if root then root.CFrame = CFrame.new(pos) end
end

-- AUTOFARM LOGIC (1-3 manual, 4+ waypoint)
local function startAutoFarm()
    if autofarm then return end
    autofarm = true
    deliveryCount = 0
    task.spawn(function()
        while autofarm and character and character:FindFirstChild("HumanoidRootPart") do
            deliveryCount += 1
            local target

            -- Pengantaran 1-3 pakai koordinat manual
            if deliveryCount <= 3 then
                local idx = ((deliveryCount-1) % #ManualLocations) + 1
                target = ManualLocations[idx]
            else
                -- Pengantaran ke-4+ cari waypoint terdekat
                target = getNearestWaypoint()
                if not target then
                    -- Kalau tidak ada waypoint, kembali ke manual
                    local idx = ((deliveryCount-1) % #ManualLocations) + 1
                    target = ManualLocations[idx]
                end
            end

            tp(target)
            task.wait(0.8)
            holdE5()
            task.wait(customDelay)  -- PAKAI DELAY DARI UI
        end
    end)
end
local function stopAutoFarm() autofarm = false end

-- FLY, NOCLIP, ESP (sama, tidak diubah)
local function startFly()
    if flying then return end
    flying = true
    local root = character:FindFirstChild("HumanoidRootPart")
    local bv = Instance.new("BodyVelocity", root); bv.MaxForce = Vector3.new(1e5,1e5,1e5)
    local bg = Instance.new("BodyGyro", root); bg.MaxTorque = Vector3.new(9e9,9e9,9e9); bg.P = 9e4
    spawn(function()
        while flying do
            local move = Vector3.new(0,0,0)
            if UserInputService:IsKeyDown(Enum.KeyCode.W) then move += cam.CFrame.LookVector end
            if UserInputService:IsKeyDown(Enum.KeyCode.S) then move -= cam.CFrame.LookVector end
            if UserInputService:IsKeyDown(Enum.KeyCode.A) then move -= cam.CFrame.RightVector end
            if UserInputService:IsKeyDown(Enum.KeyCode.D) then move += cam.CFrame.RightVector end
            if UserInputService:IsKeyDown(Enum.KeyCode.Space) then move += Vector3.new(0,1,0) end
            if UserInputService:IsKeyDown(Enum.KeyCode.LeftControl) then move -= Vector3.new(0,1,0) end
            bv.Velocity = move * 140
            bg.CFrame = cam.CFrame
            RunService.Heartbeat:Wait()
        end
        bv:Destroy(); bg:Destroy()
    end)
end

-- NOCLIP
RunService.Stepped:Connect(function()
    if noclip and character then
        for _, p in character:GetDescendants() do
            if p:IsA("BasePart") then p.CanCollide = false end
        end
    end
end)

-- ESP (sama seperti sebelumnya, tidak diubah)

--------------------------------------------------
-- UI KECIL, HITAM, BISA DIGESER, PREMIUM TAG
--------------------------------------------------

local sg = Instance.new("ScreenGui", game.CoreGui)
sg.Name = "MiyoshiV12"
sg.ResetOnSpawn = false

local open = Instance.new("TextButton", sg)
open.Size = UDim2.new(0,55,0,55)
open.Position = UDim2.new(1,-70,1,-70)
open.BackgroundColor3 = Color3.new(1,1,1)
open.Text = "M"
open.TextSize = 32
open.Font = Enum.Font.GothamBlack
open.Visible = false
Instance.new("UICorner", open).CornerRadius = UDim.new(1,0)

local main = Instance.new("Frame", sg)
main.Size = UDim2.new(0,380,0,400)
main.Position = UDim2.new(0.5,-190,0.5,-200)
main.BackgroundColor3 = Color3.fromRGB(12,12,12)
main.BorderSizePixel = 0
Instance.new("UICorner", main).CornerRadius = UDim.new(0,14)
local st = Instance.new("UIStroke", main)
st.Color = Color3.fromRGB(255,215,0)
st.Thickness = 3.5

-- PREMIUM
local prem = Instance.new("TextLabel", main)
prem.Size = UDim2.new(1,0,0,40)
prem.BackgroundTransparency = 1
prem.Text = "PREMIUM"
prem.TextColor3 = Color3.fromRGB(255,215,0)
prem.TextStrokeTransparency = 0
prem.TextSize = 36
prem.Font = Enum.Font.GothamBlack

local title = Instance.new("TextLabel", main)
title.Position = UDim2.new(0,0,0,35)
title.Size = UDim2.new(1,0,0,35)
title.BackgroundTransparency = 1
title.Text = "MIYOSHI BLACK v12"
title.TextColor3 = Color3.new(1,1,1)
title.TextSize = 24
title.Font = Enum.Font.GothamBold

-- Money + Profit
local moneyL = Instance.new("TextLabel", main)
moneyL.Position = UDim2.new(0,10,0,75)
moneyL.Size = UDim2.new(1,-20,0,35)
moneyL.BackgroundColor3 = Color3.fromRGB(0,40,0)
moneyL.TextColor3 = Color3.fromRGB(0,255,100)
moneyL.Text = "Money: 0$"
Instance.new("UICorner", moneyL).CornerRadius = UDim.new(0,8)

local profitL = Instance.new("TextLabel", main)
profitL.Position = UDim2.new(0,10,0,115)
profitL.Size = UDim2.new(1,-20,0,30)
profitL.BackgroundColor3 = Color3.fromRGB(50,50,0)
profitL.TextColor3 = Color3.fromRGB(255,255,100)
profitL.Text = "Profit/min: 0$"
Instance.new("UICorner", profitL).CornerRadius = UDim.new(0,8)

-- Delay Box
local delayBox = Instance.new("TextBox", main)
delayBox.Position = UDim2.new(0.5,-170,0,155)
delayBox.Size = UDim2.new(0,340,0,40)
delayBox.BackgroundColor3 = Color3.fromRGB(60,0,60)
delayBox.Text = "Delay: 6s"
delayBox.TextColor3 = Color3.new(1,1,1)
delayBox.FocusLost:Connect(function(e)
    if e then
        local n = tonumber(delayBox.Text:match("%d+"))
        if n and n>=1 and n<=30 then customDelay = n delayBox.Text = "Delay: "..n.."s" end
    end
end)
Instance.new("UICorner", delayBox).CornerRadius = UDim.new(0,10)

-- Update money & profit
spawn(function()
    while task.wait(1) do
        moneyL.Text = "Money: "..string.format("%,d", getMoney()).."$"
        profitL.Text = "Profit/min: "..string.format("%,d", profitPerMin).."$"
    end
end)

-- Buttons
local y = 205
local function btn(txt,col,func)
    local b = Instance.new("TextButton", main)
    b.Size = UDim2.new(0,340,0,40)
    b.Position = UDim2.new(0.5,-170,0,y)
    b.BackgroundColor3 = col
    b.Text = txt
    b.TextColor3 = Color3.new(1,1,1)
    b.TextSize = 19
    b.Font = Enum.Font.GothamBold
    Instance.new("UICorner", b).CornerRadius = UDim.new(0,10)
    b.MouseButton1Click:Connect(func)
    y += 48
end

btn("START AUTOFARM",Color3.fromRGB(0,200,0),startAutoFarm)
btn("STOP AUTOFARM",Color3.fromRGB(200,0,0),stopAutoFarm)
btn("TOGGLE FLY",Color3.fromRGB(0,140,255),function() flying=not flying if flying then startFly() end end)
btn("TOGGLE NOCLIP",Color3.fromRGB(255,165,0),function() noclip=not noclip end)
btn("TOGGLE ESP",Color3.fromRGB(200,0,255),function() espEnabled=not espEnabled end)
btn("MIYOSHI NAME",Color3.fromRGB(255,80,80),setMiyoshiName)

-- WalkSpeed
local ws = Instance.new("TextBox", main)
ws.Size = UDim2.new(0,340,0,40)
ws.Position = UDim2.new(0.5,-170,0,y)
ws.BackgroundColor3 = Color3.fromRGB(80,0,80)
ws.Text = "WalkSpeed: 16"
ws.TextColor3 = Color3.new(1,1,1)
ws.FocusLost:Connect(function(e)
    if e then local n=tonumber(ws.Text:match("%d+")) if n and n>=16 and n<=500 then character.Humanoid.WalkSpeed=n ws.Text="WalkSpeed: "..n end end
end)
Instance.new("UICorner", ws).CornerRadius = UDim.new(0,10)

-- Hide & Drag
local hidex = Instance.new("TextButton", main)
hidex.Size = UDim2.new(0,36,0,36)
hidex.Position = UDim2.new(1,-44,0,6)
hidex.BackgroundColor3 = Color3.fromRGB(255,50,50)
hidex.Text = "X"
hidex.MouseButton1Click:Connect(function() main.Visible=false open.Visible=true end)
open.MouseButton1Click:Connect(function() main.Visible=true open.Visible=false end)

-- DRAG
local drag = false
local ds, sp
main.InputBegan:Connect(function(i) if i.UserInputType==Enum.UserInputType.MouseButton1 then drag=true ds=i.Position sp=main.Position end end)
UserInputService.InputChanged:Connect(function(i)
    if drag and i.UserInputType==Enum.UserInputType.MouseMovement then
        local delta = i.Position - ds
        main.Position = UDim2.new(sp.X.Scale, sp.X.Offset+delta.X, sp.Y.Scale, sp.Y.Offset+delta.Y)
    end
end)
main.InputEnded:Connect(function() drag=false end)

task.wait(3)
setMiyoshiName()
print("MIYOSHI BLACK v12 FINAL - 1-3 Manual, 4+ Waypoint, No Bug!")
