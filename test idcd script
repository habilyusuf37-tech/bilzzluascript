-- MIYOSHI AUTOFARM v9.0 - Auto Follow Waypoint + Hold E 5s + Teleport 6s

local Players = game:GetService("Players")
local VirtualInputManager = game:GetService("VirtualInputManager")
local UserInputService = game:GetService("UserInputService")
local RunService = game:GetService("RunService")
local player = Players.LocalPlayer
local character = player.Character or player.CharacterAdded:Wait()

-- Koordinat manual (cadangan kalau tidak ada marker)
local ManualLocations = {
    Vector3.new(2879, 4, -863),
    Vector3.new(-5, 4, 25),
    Vector3.new(3141, 5, -111)
}

local autofarm = false
local flying = false
local walkSpeed = 16

-- CARI WAYPOINT MARKER OTOMATIS (bisa namanya "Waypoint", "Marker", "Path", dll)
local function findNextWaypoint()
    for _, obj in ipairs(workspace:GetDescendants()) do
        if obj:IsA("Part") or obj:IsA("MeshPart") or obj:IsA("Model") then
            local name = obj.Name:lower()
            if name:find("way") or name:find("mark") or name:find("point") or name:find("path") or name:find("target") then
                if obj:IsA("BasePart") then
                    return obj.Position + Vector3.new(0, 5, 0)
                elseif obj:FindFirstChild("HumanoidRootPart") then
                    return obj.HumanoidRootPart.Position + Vector3.new(0, 5, 0)
                elseif obj:FindFirstChildWhichIsA("BasePart") then
                    return obj:FindFirstChildWhichIsA("BasePart").Position + Vector3.new(0, 5, 0)
                end
            end
        end
    end
    return nil
end

-- NAMA JADI "hide name by miyoshi"
local function setMiyoshiName()
    if character and character:FindFirstChild("Head") then
        for _, v in character.Head:GetChildren() do
            if v:IsA("BillboardGui") then
                for _, lbl in v:GetDescendants() do
                    if lbl:IsA("TextLabel") then
                        lbl.Text = "hide name by miyoshi"
                        lbl.TextColor3 = Color3.fromRGB(255,255,255)
                        lbl.TextStrokeTransparency = 0
                        lbl.TextStrokeColor3 = Color3.new(0,0,0)
                        lbl.Font = Enum.Font.GothamBold
                        lbl.TextSize = 20
                    end
                end
            end
        end
    end
end

player.CharacterAdded:Connect(function(char)
    character = char
    task.wait(2)
    setMiyoshiName()
end)

-- GET MONEY
local function getMoney()
    if player:FindFirstChild("leaderstats") then
        for _, v in player.leaderstats:GetChildren() do
            if (v:IsA("IntValue") or v:IsA("NumberValue")) and (string.find(v.Name:lower(), "money") or string.find(v.Name:lower(), "cash") or string.find(v.Name:lower(), "coin")) then
                return v.Value
            end
        end
    end
    return 0
end

-- FLY
local function startFly()
    if flying then return end
    flying = true
    local root = character:FindFirstChild("HumanoidRootPart")
    local bv = Instance.new("BodyVelocity", root); bv.MaxForce = Vector3.new(1e5,1e5,1e5)
    local bg = Instance.new("BodyGyro", root); bg.MaxTorque = Vector3.new(9e9,9e9,9e9); bg.P = 9e4
    spawn(function()
        while flying and root and root.Parent do
            local cam = workspace.CurrentCamera
            local move = Vector3.new(0,0,0)
            if UserInputService:IsKeyDown(Enum.KeyCode.W) then move += cam.CFrame.LookVector end
            if UserInputService:IsKeyDown(Enum.KeyCode.S) then move -= cam.CFrame.LookVector end
            if UserInputService:IsKeyDown(Enum.KeyCode.A) then move -= cam.CFrame.RightVector end
            if UserInputService:IsKeyDown(Enum.KeyCode.D) then move += cam.CFrame.RightVector end
            if UserInputService:IsKeyDown(Enum.KeyCode.Space) then move += Vector3.new(0,1,0) end
            if UserInputService:IsKeyDown(Enum.KeyCode.LeftControl) then move -= Vector3.new(0,1,0) end
            bv.Velocity = move * 120
            bg.CFrame = cam.CFrame
            RunService.Heartbeat:Wait()
        end
        bv:Destroy(); bg:Destroy()
    end)
end
local function stopFly() flying = false end

-- WALK SPEED
local function setWalkSpeed(s)
    if character and character:FindFirstChild("Humanoid") then
        character.Humanoid.WalkSpeed = s
        walkSpeed = s
    end
end

-- HOLD E 5 DETIK
local function holdE5()
    VirtualInputManager:SendKeyEvent(true, Enum.KeyCode.E, false, game)
    task.wait(5)
    VirtualInputManager:SendKeyEvent(false, Enum.KeyCode.E, false, game)
end

-- TELEPORT KE POSISI
local function teleportTo(pos)
    local root = character:FindFirstChild("HumanoidRootPart")
    if root then
        root.CFrame = CFrame.new(pos)
    end
end

-- AUTOFARM - Prioritas: Ikuti marker â†’ kalau nggak ada, pakai koordinat manual
local function startAutoFarm()
    if autofarm then return end
    autofarm = true
    task.spawn(function()
        local manualIndex = 1
        while autofarm and character and character:FindFirstChild("HumanoidRootPart") do
            local targetPos = findNextWaypoint()

            -- Kalau ada marker otomatis, pakai itu
            if targetPos then
                teleportTo(targetPos)
                task.wait(0.8)
                holdE5()           -- Hold E 5 detik
                task.wait(6)       -- Delay 6 detik
            else
                -- Kalau nggak ada marker, pakai koordinat manual
                local pos = ManualLocations[manualIndex]
                teleportTo(pos)
                task.wait(0.8)
                holdE5()
                task.wait(6)
                manualIndex = (manualIndex % #ManualLocations) + 1
            end
        end
    end)
end
local function stopAutoFarm() autofarm = false end

--------------------------------------------------
-- GUI MENU KECIL & ELEGAN
--------------------------------------------------

local ScreenGui = Instance.new("ScreenGui")
ScreenGui.Name = "MiyoshiHub"
ScreenGui.ResetOnSpawn = false
ScreenGui.Parent = game.CoreGui

local OpenBtn = Instance.new("TextButton")
OpenBtn.Size = UDim2.new(0,60,0,60)
OpenBtn.Position = UDim2.new(1,-80,1,-80)
OpenBtn.BackgroundColor3 = Color3.new(1,1,1)
OpenBtn.Text = "B"
OpenBtn.TextSize = 34
OpenBtn.Font = Enum.Font.GothamBlack
OpenBtn.Visible = false
OpenBtn.Parent = ScreenGui
Instance.new("UICorner", OpenBtn).CornerRadius = UDim.new(1,0)

local Main = Instance.new("Frame")
Main.Size = UDim2.new(0,400,0,360)
Main.Position = UDim2.new(0.5,-200,0.5,-180)
Main.BackgroundColor3 = Color3.fromRGB(20,20,30)
Main.Parent = ScreenGui
Instance.new("UICorner", Main).CornerRadius = UDim.new(0,14)
local stroke = Instance.new("UIStroke", Main); stroke.Color = Color3.fromRGB(0,255,255); stroke.Thickness = 3

local Title = Instance.new("TextLabel")
Title.Size = UDim2.new(1,0,0,45)
Title.BackgroundTransparency = 1
Title.Text = "MIYOSHI AUTOFARM"
Title.TextColor3 = Color3.fromRGB(0,255,255)
Title.TextSize = 26
Title.Font = Enum.Font.GothamBold
Title.Parent = Main

local MoneyLabel = Instance.new("TextLabel")
MoneyLabel.Size = UDim2.new(1,-20,0,35)
MoneyLabel.Position = UDim2.new(0,10,0,50)
MoneyLabel.BackgroundTransparency = 0.7
MoneyLabel.BackgroundColor3 = Color3.new(0,0,0)
MoneyLabel.Text = "Money: Loading..."
MoneyLabel.TextColor3 = Color3.fromRGB(0,255,100)
MoneyLabel.TextSize = 20
MoneyLabel.Font = Enum.Font.GothamBold
MoneyLabel.Parent = Main
Instance.new("UICorner", MoneyLabel).CornerRadius = UDim.new(0,8)

spawn(function()
    while task.wait(1) do
        if Main.Parent then
            MoneyLabel.Text = "Money: "..string.format("%,d", getMoney()).."$"
        end
    end
end)

local y = 95
local function btn(text, col, func)
    local b = Instance.new("TextButton")
    b.Size = UDim2.new(0,360,0,45)
    b.Position = UDim2.new(0.5,-180,0,y)
    b.BackgroundColor3 = col
    b.Text = text
    b.TextColor3 = Color3.new(1,1,1)
    b.TextSize = 20
    b.Font = Enum.Font.GothamBold
    b.Parent = Main
    Instance.new("UICorner", b).CornerRadius = UDim.new(0,10)
    b.MouseButton1Click:Connect(func)
    y = y + 52
end

btn("START AUTOFARM", Color3.fromRGB(0,180,0), startAutoFarm)
btn("STOP AUTOFARM", Color3.fromRGB(180,0,0), stopAutoFarm)
btn("TOGGLE FLY", Color3.fromRGB(0,140,255), function() if flying then stopFly() else startFly() end end)
btn("MIYOSHI NAME", Color3.fromRGB(255,80,80), setMiyoshiName)

local SpeedBox = Instance.new("TextBox")
SpeedBox.Size = UDim2.new(0,360,0,45)
SpeedBox.Position = UDim2.new(0.5,-180,0,y)
SpeedBox.BackgroundColor3 = Color3.fromRGB(50,50,60)
SpeedBox.Text = "WalkSpeed: 16"
SpeedBox.TextColor3 = Color3.new(1,1,1)
SpeedBox.TextSize = 20
SpeedBox.Parent = Main
Instance.new("UICorner", SpeedBox).CornerRadius = UDim.new(0,10)

SpeedBox.FocusLost:Connect(function(enter)
    if enter then
        local n = tonumber(SpeedBox.Text:match("%d+"))
        if n and n >= 16 and n <= 500 then
            setWalkSpeed(n)
            SpeedBox.Text = "WalkSpeed: "..n
        end
    end
end)

local HideX = Instance.new("TextButton")
HideX.Size = UDim2.new(0,40,0,40)
HideX.Position = UDim2.new(1,-48,0,8)
HideX.BackgroundColor3 = Color3.fromRGB(255,50,50)
HideX.Text = "X"
HideX.TextSize = 26
HideX.Parent = Main
Instance.new("UICorner", HideX).CornerRadius = UDim.new(1,0)
HideX.MouseButton1Click:Connect(function() Main.Visible = false; OpenBtn.Visible = true end)
OpenBtn.MouseButton1Click:Connect(function() Main.Visible = true; OpenBtn.Visible = false end)

-- Draggable
local dragging = false
Main.InputBegan:Connect(function(i)
    if i.UserInputType == Enum.UserInputType.MouseButton1 then
        dragging = true
        dragStart = i.Position
        startPos = Main.Position
    end
end)
UserInputService.InputChanged:Connect(function(i)
    if dragging and i.UserInputType == Enum.UserInputType.MouseMovement then
        local delta = i.Position - dragStart
        Main.Position = UDim2.new(startPos.X.Scale, startPos.X.Offset + delta.X, startPos.Y.Scale, startPos.Y.Offset + delta.Y)
    end
end)
Main.InputEnded:Connect(function(i) if i.UserInputType == Enum.UserInputType.MouseButton1 then dragging = false end end)

-- Jalankan nama Miyoshi
task.wait(3)
setMiyoshiName()

print("MIYOSHI AUTOFARM LOADED! Auto follow waypoint + Hold E 5s + Teleport 6s")
